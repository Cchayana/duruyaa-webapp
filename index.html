<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢—É–≤–∏–Ω—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏</title>
  <script defer>
    let cards = [];
    let current = 0;
    let modules = [];
    let userId;
let initData = "";
try {
  initData = Telegram.WebApp.initData;
} catch (e) {
  document.getElementById("user-id-display").textContent = "‚ùå Telegram WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω.";
}

if (initData) {
fetch("https://0df3-194-233-63-59.ngrok-free.app/auth", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ initData })
})
.then(async res => {
  const text = await res.text();
  try {
    const data = JSON.parse(text);
    if (data.ok) {
      userId = data.user_id;
      loadModules();
    } else {
      document.getElementById("user-id-display").textContent = `‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${data.error}
initData: ${initData}`;
    }
  } catch (e) {
    document.getElementById("user-id-display").textContent = `‚ùå –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ JSON:
${text}
initData: ${initData}`;
  }
})
.catch(err => {
  document.getElementById("user-id-display").textContent = `‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ${err.message}
initData: ${initData}`;
});
} // –∫–æ–Ω–µ—Ü —É—Å–ª–æ–≤–∏—è initData

const audio = new Audio();

    async function loadModules() {
      const res = await fetch('modules.json');
      modules = await res.json();

      const accessRes = await fetch('access.json');
      const access = await accessRes.json();

      showModuleList(access);
    }

    function showModuleList(access) {
      document.getElementById("module-list").style.display = 'block';
      document.getElementById("card-view").style.display = 'none';

      document.getElementById("user-id-display").textContent = `–í–∞—à ID: ${userId}`;
document.getElementById("debug-user-id").textContent = `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${userId}`;
console.log("userId:", userId);

      const list = document.getElementById("modules");
      list.innerHTML = '';
      const allowed = new Set((access[userId] || []).concat(access["all"] || []));

      modules.forEach(module => {
        const btn = document.createElement("button");
        btn.textContent = allowed.has(module.id) ? module.name : module.name + " üîí";
        btn.disabled = !allowed.has(module.id);
        btn.onclick = () => enterModule(module.id);
        list.appendChild(btn);
      });
    }

    function enterModule(moduleId) {
      const module = modules.find(m => m.id === moduleId);
      if (!module || !module.cards) return;
      cards = [...module.cards];
      shuffle(cards);
      current = 0;
      showCard();
      document.getElementById("module-list").style.display = 'none';
      document.getElementById("card-view").style.display = 'flex';
    }

    async function exitModule() {
  const accessRes = await fetch('access.json');
  const access = await accessRes.json();
  showModuleList(access);
}
